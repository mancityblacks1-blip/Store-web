<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…ÙˆÙ„Ù‘Ø¯ Ø¹Ø±ÙˆØ¶ Ø£Ø³Ø¹Ø§Ø± + ÙÙˆØ§ØªÙŠØ± (Ù…Ù„Ù ÙˆØ§Ø­Ø¯)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ØªØ­Ø³ÙŠÙ† Ø·Ø¨Ø§Ø¹Ø© PDF */
    @media print {
      body { background: white !important; }
      .no-print { display: none !important; }
      .print-area { box-shadow: none !important; border: none !important; }
      .print-container { max-width: 100% !important; padding: 0 !important; }
      .print-card { border: none !important; }
    }
    .shadow-soft { box-shadow: 0 10px 30px rgba(0,0,0,.06); }
  </style>
</head>

<body class="bg-zinc-50 text-zinc-900">
  <header class="no-print border-b border-zinc-200 bg-white">
    <div class="mx-auto max-w-6xl px-4 h-14 flex items-center justify-between">
      <div class="font-semibold">ğŸ“„ Ù…ÙˆÙ„Ù‘Ø¯ Ø¹Ø±ÙˆØ¶ Ø£Ø³Ø¹Ø§Ø± + ÙÙˆØ§ØªÙŠØ±</div>
      <div class="text-xs text-zinc-600">Ù…Ù„Ù ÙˆØ§Ø­Ø¯ â€¢ Ø¨Ø¯ÙˆÙ† Backend</div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-6 print-container">
    <div class="grid gap-4 lg:grid-cols-3">
      <!-- Form -->
      <section class="no-print lg:col-span-2 space-y-4">
        <div class="rounded-2xl border border-zinc-200 bg-white p-4 shadow-soft">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-lg font-semibold">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ØªÙ†Ø¯</div>
              <div class="text-sm text-zinc-600">Ø§Ù…Ù„Ø£ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ´ÙˆÙ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†</div>
            </div>
            <div class="flex items-center gap-2">
              <button id="btnSaveCompany" class="h-10 px-4 rounded-xl border border-zinc-200 bg-white hover:bg-zinc-50 text-sm">
                Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©
              </button>
              <button id="btnReset" class="h-10 px-4 rounded-xl bg-zinc-900 text-white hover:bg-zinc-800 text-sm">
                Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·
              </button>
            </div>
          </div>

          <div class="mt-4 grid gap-3 md:grid-cols-3">
            <div>
              <label class="block text-xs text-zinc-600 mb-1">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯</label>
              <select id="docType" class="h-10 w-full rounded-xl border border-zinc-200 bg-white px-3 text-sm outline-none focus:ring-2 focus:ring-zinc-300">
                <option value="quote">Ø¹Ø±Ø¶ Ø³Ø¹Ø±</option>
                <option value="invoice">ÙØ§ØªÙˆØ±Ø©</option>
              </select>
            </div>
            <div>
              <label class="block text-xs text-zinc-600 mb-1">Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯</label>
              <input id="docNo" class="h-10 w-full rounded-xl border border-zinc-200 bg-white px-3 text-sm outline-none focus:ring-2 focus:ring-zinc-300" placeholder="Ù…Ø«Ø§Ù„: Q-1001" />
            </div>
            <div>
              <label class="block text-xs text-zinc-600 mb-1">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±</label>
              <input id="issueDate" type="date" class="h-10 w-full rounded-xl border border-zinc-200 bg-white px-3 text-sm outline-none focus:ring-2 focus:ring-zinc-300" />
            </div>
          </div>

          <div class="mt-4 grid gap-3 md:grid-cols-2">
            <div class="rounded-2xl border border-zinc-200 bg-zinc-50 p-3">
              <div class="font-semibold text-sm">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©</div>
              <div class="mt-3 grid gap-3">
                <div>
                  <label class="block text-xs text-zinc-600 mb-1">Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</label>
                  <input id="companyName" class="h-10 w-full rounded-xl border border-zinc-200 bg-white px-3 text-sm outline-none focus:ring-2 focus:ring-zinc-300" placeholder="Ø§Ø³Ù… Ø´Ø±ÙƒØªÙƒ" />
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="block text-xs text-zinc-600 mb-1">Ù‡Ø§ØªÙ</label>
                    <input id="companyPhone" class="h-10 w-full rounded-xl border border-zinc-200 bg-white px-3 text-sm outline-none focus:ring-2 focus:ring-zinc-300" placeholder="01xxxxxxxxx" />
                  </div>
                  <div>
                    <label class="block text-xs text-zinc-600 mb-1">Ø§Ù„Ø¹Ù…Ù„Ø©</label>
                    <input id="currency" class="h-10 w-full rounded-xl border border-zinc-200 bg-white px-3 text-sm outline-none focus:ring-2 focus:ring-zinc-300" placeholder="EGP" />
                  </div>
                </div>
                <div>
                  <label class="block text-xs text-zinc-600 mb-1">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                  <input id="companyAddress" class="h-10 w-full rounded-xl border border-zinc-200 bg-white px-3 text-sm outline-none focus:ring-2 focus:ring-zinc-300" placeholder="Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© - Ù…ØµØ±" />
                </div>
              </div>
            </div>

            <div class="rounded-2xl border border-zinc-200 bg-zinc-50 p-3">
              <div class="font-semibold text-sm">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
              <div class="mt-3 grid gap-3">
                <div>
                  <label class="block text-xs text-zinc-600 mb-1">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                  <input id="clientName" class="h-10 w-full rounded-xl border border-zinc-200 bg-white px-3 text-sm outline-none focus:ring-2 focus:ring-zinc-300" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
                </div>
                <div>
                  <label class="block text-xs text-zinc-600 mb-1">Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                  <input id="clientPhone" class="h-10 w-full rounded-xl border border-zinc-200 bg-white px-3 text-sm outline-none focus:ring-2 focus:ring-zinc-300" placeholder="01xxxxxxxxx" />
                </div>
                <div>
                  <label class="block text-xs text-zinc-600 mb-1">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                  <input id="clientAddress" class="h-10 w-full rounded-xl border border-zinc-200 bg-white px-3 text-sm outline-none focus:ring-2 focus:ring-zinc-300" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
                </div>
              </div>
            </div>
          </div>

          <!-- Items -->
          <div class="mt-4 rounded-2xl border border-zinc-200 bg-white p-3">
            <div class="flex items-center justify-between">
              <div class="font-semibold text-sm">Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø³ØªÙ†Ø¯</div>
              <button id="btnAddItem" class="h-9 px-3 rounded-xl bg-zinc-900 text-white hover:bg-zinc-800 text-sm">
                + Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯
              </button>
            </div>

            <div class="mt-3 overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="text-zinc-600">
                  <tr class="border-b border-zinc-100">
                    <th class="py-2 text-right">Ø§Ù„ÙˆØµÙ</th>
                    <th class="py-2 text-right w-20">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th class="py-2 text-right w-28">Ø§Ù„Ø³Ø¹Ø±</th>
                    <th class="py-2 text-right w-28">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    <th class="py-2 w-14"></th>
                  </tr>
                </thead>
                <tbody id="itemsBody"></tbody>
              </table>
            </div>

            <div class="mt-4 grid gap-3 md:grid-cols-3">
              <div>
                <label class="block text-xs text-zinc-600 mb-1">Ø®ØµÙ… (Ù‚ÙŠÙ…Ø©)</label>
                <input id="discount" type="number" min="0" step="0.01"
                  class="h-10 w-full rounded-xl border border-zinc-200 bg-white px-3 text-sm outline-none focus:ring-2 focus:ring-zinc-300"
                  placeholder="0" />
              </div>
              <div>
                <label class="block text-xs text-zinc-600 mb-1">Ø¶Ø±ÙŠØ¨Ø© %</label>
                <input id="taxPercent" type="number" min="0" step="0.01"
                  class="h-10 w-full rounded-xl border border-zinc-200 bg-white px-3 text-sm outline-none focus:ring-2 focus:ring-zinc-300"
                  placeholder="0" />
              </div>
              <div>
                <label class="block text-xs text-zinc-600 mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                <textarea id="notes"
                  class="min-h-[42px] w-full rounded-xl border border-zinc-200 bg-white px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-zinc-300"
                  placeholder="Ø´Ø±ÙˆØ·/Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
              </div>
            </div>

            <div class="mt-4 flex items-center justify-between gap-3">
              <div class="text-xs text-zinc-600">
                Ù†ØµÙŠØ­Ø©: Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ø¶ØºØ· <b>Ø·Ø¨Ø§Ø¹Ø© PDF</b> ÙˆØ§Ø®ØªØ± â€œSave as PDFâ€.
              </div>
              <div class="flex items-center gap-2">
                <button id="btnDownload" class="h-10 px-4 rounded-xl bg-zinc-900 text-white hover:bg-zinc-800 text-sm">
                  ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© PDF
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Preview -->
      <section class="lg:col-span-1">
        <div class="rounded-2xl border border-zinc-200 bg-white p-4 shadow-soft print-area print-card" id="printArea">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-xl font-semibold" id="previewTitle">Ø¹Ø±Ø¶ Ø³Ø¹Ø±</div>
              <div class="text-xs text-zinc-600 mt-1">
                Ø±Ù‚Ù…: <span class="font-mono" id="previewDocNo">â€”</span> â€¢
                ØªØ§Ø±ÙŠØ®: <span id="previewDate">â€”</span>
              </div>
            </div>
            <div class="text-right">
              <div class="font-semibold" id="previewCompany">â€”</div>
              <div class="text-xs text-zinc-600" id="previewCompanyMeta">â€”</div>
            </div>
          </div>

          <div class="mt-4 rounded-xl border border-zinc-200 bg-zinc-50 p-3">
            <div class="text-xs text-zinc-600">Ù…ÙˆØ¬Ù‡ Ø¥Ù„Ù‰</div>
            <div class="font-semibold" id="previewClient">â€”</div>
            <div class="text-xs text-zinc-600" id="previewClientMeta">â€”</div>
          </div>

          <div class="mt-4 overflow-x-auto">
            <table class="w-full text-xs">
              <thead class="text-zinc-600">
                <tr class="border-b border-zinc-200">
                  <th class="py-2 text-right">Ø§Ù„Ø¨Ù†Ø¯</th>
                  <th class="py-2 text-right w-10">Ùƒ</th>
                  <th class="py-2 text-right w-20">Ø³Ø¹Ø±</th>
                  <th class="py-2 text-right w-20">Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                </tr>
              </thead>
              <tbody id="previewItems" class="text-zinc-900"></tbody>
            </table>
          </div>

          <div class="mt-4 border-t border-zinc-200 pt-3 text-sm">
            <div class="flex items-center justify-between">
              <div class="text-zinc-600">Subtotal</div>
              <div class="font-semibold" id="previewSubtotal">â€”</div>
            </div>
            <div class="flex items-center justify-between">
              <div class="text-zinc-600">Discount</div>
              <div class="font-semibold" id="previewDiscount">â€”</div>
            </div>
            <div class="flex items-center justify-between">
              <div class="text-zinc-600">Tax</div>
              <div class="font-semibold" id="previewTax">â€”</div>
            </div>
            <div class="mt-2 flex items-center justify-between rounded-xl bg-zinc-900 text-white px-3 py-2">
              <div class="font-semibold">Total</div>
              <div class="font-semibold" id="previewTotal">â€”</div>
            </div>
          </div>

          <div class="mt-4">
            <div class="text-xs text-zinc-600">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</div>
            <div class="text-sm whitespace-pre-wrap" id="previewNotes">â€”</div>
          </div>

          <div class="mt-6 text-[10px] text-zinc-500">
            ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø¨ÙˆØ§Ø³Ø·Ø© Ù…ÙˆÙ„Ù‘Ø¯ Ù…Ø³ØªÙ†Ø¯Ø§Øª (Ù†Ø³Ø®Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©).
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    const LS_KEY = "docgen_company_v1";

    const els = {
      docType: document.getElementById("docType"),
      docNo: document.getElementById("docNo"),
      issueDate: document.getElementById("issueDate"),

      companyName: document.getElementById("companyName"),
      companyPhone: document.getElementById("companyPhone"),
      companyAddress: document.getElementById("companyAddress"),
      currency: document.getElementById("currency"),

      clientName: document.getElementById("clientName"),
      clientPhone: document.getElementById("clientPhone"),
      clientAddress: document.getElementById("clientAddress"),

      discount: document.getElementById("discount"),
      taxPercent: document.getElementById("taxPercent"),
      notes: document.getElementById("notes"),

      itemsBody: document.getElementById("itemsBody"),

      btnAddItem: document.getElementById("btnAddItem"),
      btnDownload: document.getElementById("btnDownload"),
      btnSaveCompany: document.getElementById("btnSaveCompany"),
      btnReset: document.getElementById("btnReset"),

      // preview
      previewTitle: document.getElementById("previewTitle"),
      previewDocNo: document.getElementById("previewDocNo"),
      previewDate: document.getElementById("previewDate"),
      previewCompany: document.getElementById("previewCompany"),
      previewCompanyMeta: document.getElementById("previewCompanyMeta"),
      previewClient: document.getElementById("previewClient"),
      previewClientMeta: document.getElementById("previewClientMeta"),
      previewItems: document.getElementById("previewItems"),
      previewSubtotal: document.getElementById("previewSubtotal"),
      previewDiscount: document.getElementById("previewDiscount"),
      previewTax: document.getElementById("previewTax"),
      previewTotal: document.getElementById("previewTotal"),
      previewNotes: document.getElementById("previewNotes")
    };

    let items = [
      { name: "Ø®Ø¯Ù…Ø© 1", qty: 1, price: 1000 },
      { name: "Ø®Ø¯Ù…Ø© 2", qty: 2, price: 250 }
    ];

    function fmtDate(isoDate) {
      if (!isoDate) return "â€”";
      try {
        const d = new Date(isoDate + "T00:00:00");
        return d.toLocaleDateString("ar-EG");
      } catch { return isoDate; }
    }

    function money(n) {
      const cur = (els.currency.value || "EGP").trim();
      const v = Number.isFinite(n) ? n : 0;
      return v.toFixed(2) + " " + cur;
    }

    function num(v, fallback = 0) {
      const x = Number(v);
      return Number.isFinite(x) ? x : fallback;
    }

    function compute() {
      const subtotal = items.reduce((s, it) => s + num(it.qty) * num(it.price), 0);
      const discount = Math.max(0, num(els.discount.value, 0));
      const afterDiscount = Math.max(0, subtotal - discount);
      const taxPercent = Math.max(0, num(els.taxPercent.value, 0));
      const tax = afterDiscount * (taxPercent / 100);
      const total = afterDiscount + tax;
      return { subtotal, discount, taxPercent, tax, total };
    }

    function renderItemsTable() {
      els.itemsBody.innerHTML = "";
      items.forEach((it, idx) => {
        const tr = document.createElement("tr");
        tr.className = "border-b border-zinc-100";
        tr.innerHTML = `
          <td class="py-2">
            <input data-k="name" data-i="${idx}" class="h-10 w-full rounded-xl border border-zinc-200 bg-white px-3 text-sm outline-none focus:ring-2 focus:ring-zinc-300" value="${escapeHtml(it.name)}" />
          </td>
          <td class="py-2">
            <input data-k="qty" data-i="${idx}" type="number" min="0" step="1" class="h-10 w-full rounded-xl border border-zinc-200 bg-white px-3 text-sm outline-none focus:ring-2 focus:ring-zinc-300" value="${it.qty}" />
          </td>
          <td class="py-2">
            <input data-k="price" data-i="${idx}" type="number" min="0" step="0.01" class="h-10 w-full rounded-xl border border-zinc-200 bg-white px-3 text-sm outline-none focus:ring-2 focus:ring-zinc-300" value="${it.price}" />
          </td>
          <td class="py-2 text-sm font-semibold">${money(num(it.qty) * num(it.price))}</td>
          <td class="py-2 text-left">
            <button data-del="${idx}" class="h-9 w-9 rounded-xl border border-zinc-200 bg-white hover:bg-zinc-50">âœ•</button>
          </td>
        `;
        els.itemsBody.appendChild(tr);
      });
    }

    function renderPreview() {
      const type = els.docType.value;
      els.previewTitle.textContent = type === "invoice" ? "ÙØ§ØªÙˆØ±Ø©" : "Ø¹Ø±Ø¶ Ø³Ø¹Ø±";

      els.previewDocNo.textContent = (els.docNo.value || "â€”").trim();
      els.previewDate.textContent = fmtDate(els.issueDate.value);

      const companyName = (els.companyName.value || "â€”").trim();
      const companyPhone = (els.companyPhone.value || "").trim();
      const companyAddress = (els.companyAddress.value || "").trim();

      els.previewCompany.textContent = companyName;
      els.previewCompanyMeta.textContent = [companyPhone, companyAddress].filter(Boolean).join(" â€¢ ") || "â€”";

      const clientName = (els.clientName.value || "â€”").trim();
      const clientPhone = (els.clientPhone.value || "").trim();
      const clientAddress = (els.clientAddress.value || "").trim();

      els.previewClient.textContent = clientName;
      els.previewClientMeta.textContent = [clientPhone, clientAddress].filter(Boolean).join(" â€¢ ") || "â€”";

      // Items preview
      els.previewItems.innerHTML = "";
      if (items.length === 0) {
        els.previewItems.innerHTML = `<tr><td colspan="4" class="py-3 text-center text-zinc-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯</td></tr>`;
      } else {
        items.forEach((it) => {
          const tr = document.createElement("tr");
          tr.className = "border-b border-zinc-100";
          tr.innerHTML = `
            <td class="py-2 text-right">${escapeHtml(it.name)}</td>
            <td class="py-2 text-right">${num(it.qty)}</td>
            <td class="py-2 text-right">${money(num(it.price))}</td>
            <td class="py-2 text-right font-semibold">${money(num(it.qty) * num(it.price))}</td>
          `;
          els.previewItems.appendChild(tr);
        });
      }

      const { subtotal, discount, tax, total } = compute();
      els.previewSubtotal.textContent = money(subtotal);
      els.previewDiscount.textContent = money(discount);
      els.previewTax.textContent = money(tax);
      els.previewTotal.textContent = money(total);

      const notes = (els.notes.value || "").trim();
      els.previewNotes.textContent = notes || "â€”";
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function sync() {
      renderItemsTable();
      renderPreview();
    }

    function saveCompany() {
      const data = {
        companyName: els.companyName.value,
        companyPhone: els.companyPhone.value,
        companyAddress: els.companyAddress.value,
        currency: els.currency.value
      };
      localStorage.setItem(LS_KEY, JSON.stringify(data));
      toast("âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©");
    }

    function loadCompany() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        els.companyName.value = data.companyName || "";
        els.companyPhone.value = data.companyPhone || "";
        els.companyAddress.value = data.companyAddress || "";
        els.currency.value = data.currency || "EGP";
      } catch {}
    }

    function resetAll() {
      if (!confirm("Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ø¨Ù†ÙˆØ¯ØŸ")) return;
      els.docType.value = "quote";
      els.docNo.value = "";
      els.issueDate.value = "";
      els.clientName.value = "";
      els.clientPhone.value = "";
      els.clientAddress.value = "";
      els.discount.value = "";
      els.taxPercent.value = "";
      els.notes.value = "";
      items = [{ name: "Ø®Ø¯Ù…Ø© 1", qty: 1, price: 1000 }];
      sync();
    }

    // tiny toast
    function toast(msg) {
      const el = document.createElement("div");
      el.className =
        "fixed left-1/2 top-4 -translate-x-1/2 z-50 rounded-xl bg-zinc-900 text-white px-4 py-2 text-sm shadow-soft";
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 1800);
    }

    // Events
    els.btnAddItem.addEventListener("click", () => {
      items.push({ name: "Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯", qty: 1, price: 0 });
      sync();
    });

    els.itemsBody.addEventListener("input", (e) => {
      const t = e.target;
      if (!(t instanceof HTMLInputElement)) return;
      const i = Number(t.dataset.i);
      const k = t.dataset.k;
      if (!Number.isFinite(i) || !k) return;

      if (k === "name") items[i].name = t.value;
      if (k === "qty") items[i].qty = num(t.value, 0);
      if (k === "price") items[i].price = num(t.value, 0);

      sync();
    });

    els.itemsBody.addEventListener("click", (e) => {
      const t = e.target;
      if (!(t instanceof HTMLElement)) return;
      const del = t.getAttribute("data-del");
      if (del !== null) {
        const idx = Number(del);
        items.splice(idx, 1);
        sync();
      }
    });

    [
      els.docType, els.docNo, els.issueDate,
      els.companyName, els.companyPhone, els.companyAddress, els.currency,
      els.clientName, els.clientPhone, els.clientAddress,
      els.discount, els.taxPercent, els.notes
    ].forEach((el) => el.addEventListener("input", sync));

    els.btnDownload.addEventListener("click", () => {
      // Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
      sync();
      window.print();
    });

    els.btnSaveCompany.addEventListener("click", saveCompany);
    els.btnReset.addEventListener("click", resetAll);

    // Init defaults
    (function init() {
      loadCompany();
      // date default today
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      els.issueDate.value = `${yyyy}-${mm}-${dd}`;

      // doc no default
      const rand = Math.floor(1000 + Math.random() * 9000);
      els.docNo.value = `Q-${rand}`;
      els.currency.value = els.currency.value || "EGP";

      sync();
    })();
  </script>
</body>
</html>
